<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastermind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<script>
    let gameOver = false;
    let random = "";
        // Math.round(Math.random()*(words.length-1));
    let winCode = "1234";
    console.log(winCode);

    let currentGuessNum = 1;
    let currentSquare = 1;
    let currentEntry = "";
    let codeLength = 4;
    let numGuesses = 5;

    //Respond to physical keyboard key press
    function wordle() {
        document.onkeydown = function (e) {
            e = e || window.event;
            // console.log("FROM PHYSICAL KEYBOARD: " + e.keyCode);
            registerKeyPress(e.keyCode);
        };
    }

    //Respond to virtual keyboard key press
    function keyboard(letter) {
        var keyValue = 0;
        if(letter == 'enter') keyValue = 13;
        else if(letter == 'delete') keyValue = 8;
        else keyValue = letter.charCodeAt(0)-32;

        // console.log("FROM VIRTUAL KEYBOARD: " + letter + " " + keyValue);
        registerKeyPress(keyValue);
    }

    //React to a key press (physical or virtual)
    function registerKeyPress(keyNum) {
        console.log("PROCESSING KEY: " + keyNum + " is game over: " + gameOver);
        //Enter a letter
        if(!gameOver) {
            if(keyNum >= 49 && keyNum <= 52) {
                addNumberToCurrentGuess(keyNum);
            }
            //Remove a number
            if(keyNum == 8) {
                deleteLastNumber();
            }
            //Submit code guess
            if(keyNum == 13 && document.getElementById(currentGuessNum + "-" + codeLength).innerHTML != "") {
                checkCurrentGuess();
            }
        }
        // else {
        //     var message = "Not a valid guess";
        //     document.getElementById("alert").innerHTML = 'Try another guess';
        //     showPopup(message);
        //     console.log(currentEntry);
        //     // console.log("YO!");
        // }
        // else if(keyNum == 13 && currentEntry.length < codeLength) {
        //     var message = "Not enough numbers";
        //     document.getElementById("alert").innerHTML = "Not enough numbers " + winCode;
        //     showPopup(message);
        // }
        // }
        else {
            // document.getElementById("alert").innerHTML = "REPLAY";
            if(keyNum == 187) {
                resetGame();
            }
        }
    }
    
    function addNumberToCurrentGuess(keyNum) {
        document.getElementById("alert").innerHTML = "";
        hidePopup();
        if(document.getElementById(currentGuessNum + "-" + currentSquare).innerHTML == "") {
            document.getElementById(currentGuessNum + "-" + currentSquare).innerHTML = String.fromCharCode(keyNum);
            document.getElementById(currentGuessNum + "-" + currentSquare).style.borderColor = "#565758";
            currentEntry += String.fromCharCode(keyNum);
        }
        if(currentSquare < codeLength) {
            currentSquare++;
            console.log("currentSquare = " + currentSquare);
        }
    }

    function deleteLastNumber() {
        document.getElementById("alert").innerHTML = "";
        hidePopup();
        if(currentSquare > 1) {
            if(currentSquare == codeLength && document.getElementById(currentGuessNum + "-" + codeLength).innerHTML != "") {
                document.getElementById(currentGuessNum + "-" + currentSquare).innerHTML = "";
                document.getElementById(currentGuessNum + "-" + currentSquare).style.borderColor = "rgb(200, 200, 200)";
            }
            else {
                document.getElementById(currentGuessNum + "-" + (currentSquare-1)).innerHTML = "";
                document.getElementById(currentGuessNum + "-" + (currentSquare-1)).style.borderColor = "rgb(200, 200, 200)";
                if(currentSquare > 1) {
                    currentSquare--;
                }
            }
            currentEntry = currentEntry.slice(0, -1);
        }
    }

    function checkCurrentGuess() {
        document.getElementById("alert").innerHTML = "";
        updateTileColors(currentEntry, currentGuessNum);
        //updateKeyboardColors();
        if(currentEntry.length == codeLength) {
            if(isValidGuess()) {
                //check for game over
                checkWin();
                checkLose();
                if(!gameOver) {
                    //prepare for next word
                    currentGuessNum++;
                    currentSquare = 1;
                    currentEntry = "";
                }
            }
            else {
                var message = "Not a valid guess";
                document.getElementById("alert").innerHTML = 'Try another guess';
                showPopup(message);
                console.log(currentEntry);
                console.log("YO!");
            }
        }
        else {
            var message = "Not enough numbers";
            document.getElementById("alert").innerHTML = "Not enough numbers " + winCode;
            showPopup(message);
        }
    }

    function isValidGuess() {
        return true;
    }
    
    function checkWin() {
        if(currentEntry == winCode) {
            var message = "Excellent!"
            if(currentGuessNum == 1) message = "Genius!";
            else if(currentGuessNum == 2) message = "Magnificent!";
            else if(currentGuessNum == 3) message = "Impressive!";
            else if(currentGuessNum == 4) message = "Splendid!";
            else if(currentGuessNum == 5) message = "Great!";
            else message = "Phew!";
            document.getElementById("alert").innerHTML = '+ to play again';
            gameOver = true;
            showPopup(message);
        }
    }

    function checkLose() {
        if(!gameOver && currentGuessNum > numGuesses) {
            // console.log("hello");
            // var message = "You lose! The number was <em>" + winCode + "</em>";
            var message = winCode;
            document.getElementById("alert").innerHTML = '+ to play again';
            gameOver = true;
            showPopup(message);
        }
    }
    
    function updateTileColors(currentEntry, currentGuessNum) {
        var colorCodes = getGuessAsColorCodes(currentEntry);
        for(var i = 0; i < colorCodes.length; i++) {

            var currentSquare = colorCodes.substring(i, i+1);
            // console.log("updateTileColors:" + colorCodes.substring(i, i+1));

            var currentTile = document.getElementById(currentGuessNum + "-" + (i+1));

            //Assign default colors
            var fillColor = "rgb(120,124,126)";
            var borderColor = "rgb(120,124,126)";
            var textColor = "#fff";

            //Determine GREENS and GOLDS
            if(currentSquare == '+') {
                fillColor = "rgb(200, 180, 90)"; //gold
                borderColor = "rgb(200, 180, 90)";
            }
            else if(currentSquare == '*') {
                fillColor = "rgb(110, 170, 100)"; //green
                borderColor = "rgb(110, 170, 100)";
            }

            //Paint the identified colors
            currentTile.style.backgroundColor = fillColor;
            currentTile.style.border = borderColor;
            currentTile.style.color = textColor;
        }
    }

    // function updateKeyboardColors() {
    //     // var keys = document.getElementsByClassName("letters");
    //     for(var r=1; r <= currentGuessNum; r++) {
    //         for(var c=1; c <= 5; c++) {
    //             var keyLetter = document.getElementById(r+"-"+c).innerHTML;
    //             // console.log("Check green: " + r + "-" + c + ": " + keyLetter + "... Am I in the number? " + winCode.indexOf(keyLetter))
    //             var key = document.getElementById(keyLetter.toLowerCase());
    //             if(isGreen(keyLetter)) {
    //                 // console.log("Key is: " + keyLetter.toLowerCase());
    //                 key.style.backgroundColor = "rgb(110, 170, 100)";
    //                 key.style.borderColor = "rgb(110, 170, 100)";
    //                 key.style.color = "white";
    //             }
    //             else if(isGold(keyLetter)) {
    //                 key.style.backgroundColor = "rgb(200, 180, 90)";
    //                 key.style.borderColor = "rgb(200, 180, 90)";
    //                 key.style.color = "white";
    //             }
    //             else { //must be gray
    //                 key.style.backgroundColor = "rgb(120, 124, 126)";
    //                 key.style.borderColor = "rgb(120, 124, 126)";
    //                 key.style.color = "white";
    //             }
    //         }
    //     }
    // }

    function isGreen(letter) {
        for(var r = 1; r <= currentGuessNum; r++) {
            for(var c = 1; c <= winCode.length; c++) {
                var nextLetter = document.getElementById(r+"-"+c).innerHTML;
                if(winCode.charAt(c-1) == nextLetter && winCode.substring(c-1, c) == letter)
                    return true;
            }
        }
        return false;
    }

    function isGold(letter) {
        return isGuessed(letter) && isInWord(letter);
    }

    function isGuessed(letter) {
        for(var r = 1; r <= currentGuessNum; r++) {
            for(var c = 1; c <= winCode.length; c++) {
                var nextLetter = document.getElementById(r+"-"+c).innerHTML;
                if(letter == nextLetter)
                    return true;
            }
        }
        return false;
    }

    function isInWord(letter) {
        return winCode.indexOf(letter) >= 0;
    }

    function getGuessAsColorCodes(guess)
    {
      var win = winCode;
      //Identify GREEN locations with "*"
      for(var i=0; i < guess.length; i++)
         if(guess.charAt(i) == win.charAt(i)) {
            guess = guess.substring(0, i) + "A" + guess.substring(i+1);
            win = win.substring(0, i) + "A" + win.substring(i+1);
         }
      
      //Identify GOLD locations with "+"
      for(var i=0; i < guess.length; i++) {
         if(guess.charAt(i) != 'A') {// && guess.charAt(i) != '+') {
            var index = win.indexOf(guess.charAt(i));
            if(index >= 0) {
               guess = guess.substring(0, i) + "B" + guess.substring(i+1);            
               win = win.substring(0, index) + "B" + win.substring(index+1);
            }
         }
      }
      
      var codeForPegs = "";
      for(var i = 0; i < guess.length; i++)
        if(guess.charAt(i) == 'A' || guess.charAt(i) == 'B')
            codeForPegs += guess.charAt(i);
      
      //Sort the code list so it displays in the desired order
      // for(var i=0; i < codeForPegs.length-1; i++)
      // {
      //     var min = i;
      //     for(var j = i + 1; j < codeForPegs.length; j++)
      //         if(codeForPegs.charAt(j) < codeForPegs.charAt(min)
      //            min = j;
      //     var charAti = codeForPegs.substring(i, i+1);
      //     var charAtmin = codeForPegs.substring(min, min+1);
      //     codeForPegs = codeForPegs.substring(0, i) + charAtmin + codeForPegs.substring(i+1, min) + charAti + codeForPegs.substring(min+1);
      // }
      
      var sorted = codeForPegs.split('').sort().join('');
      
      console.log("CURRENT VALUES: " + guess + " " + win + " " + codeForPegs + " " + sorted);
      
      return guess;   
   }

   function resetGame()
   {
        gameOver = false;
        // random = Math.round(Math.random()*(words.length-1));
        // winCode = words[random].toUpperCase();
        winCode = "4321";
        console.log("winCode = " + winCode);
        currentGuessNum = 1;
        currentSquare = 1;
        currentEntry = "";

        hidePopup();

        document.getElementById("alert").innerHTML = "Welcome to Mastermind";

        //Assign default colors
        // var fillColor = "#fff";
        var fillColor = "white";
        var borderColor = "rgb(200,200,200)";
        var textColor = "black";

        //reset the board tiles
        for(var r = 1; r <= numGuesses; r++) {
            for(var c = 1; c <= codeLength; c++) {

                var currentTile = document.getElementById(r + "-" + c);
                
                //Paint the identified colors
                currentTile.innerHTML = "";
                currentTile.style.backgroundColor = fillColor;
                currentTile.style.borderStyle = "solid";
                currentTile.style.borderWidth = "2px";
                currentTile.style.borderColor = borderColor;
                currentTile.style.color = textColor;
            }
        }

        //reset keyboard colors
        var keys = document.getElementsByClassName("letters");

        for(var i=0; i< keys.length; i++){
            keys[i].style.color = "black";
            keys[i].style.backgroundColor = "rgb(220,220,220)";
            keys[i].style.borderColor = "rgb(220,220,220)";
        }
    }

    function showPopup(message) {
        var popup = document.getElementById("myPopup");
        popup.innerHTML = message;
        popup.style.visibility = 'visible';
        // popup.classList.toggle('show'); explore a fade
    }

    function hidePopup() {
        var popup = document.getElementById("myPopup");
        popup.innerHTML = "";
        popup.style.visibility = 'hidden';
    }

</script>

<body onload="wordle()">
    <div class="row" id="navbar">
        <div class="col-3">
        </div>
        <!-- <div class="col-6 d-flex justify-content-center"> -->
            <a class="navbar-brand text-center">
                <h1 class="mt-3" style="font-family: serif">Mastermind</h1>
            </a>
        <!-- </div> -->
        <div class="col-3">
        </div>
    </div>

    <div class="center popup">
        <div class="popuptext" id="myPopup">Mastermind!</div>
    </div>

    <div class="container d-flex justify-content-center mt-3">
        <table>
            <tr>
                <td id="1-1"></td>
                <td id="1-2"></td>
                <td id="1-3"></td>
                <td id="1-4"></td>
                <td id="pegbox"
                    <div class="peg-container">
                        <div class="peg" id="pegs1-1"></div>
                        <div class="peg" id="pegs1-2"></div>
                        <div class="peg" id="pegs1-3"></div>
                        <div class="peg" id="pegs1-4"></div>
                    </div>
                </td>
            </tr>
            <tr class="m-2">
                <td id="2-1"></td>
                <td id="2-2"></td>
                <td id="2-3"></td>
                <td id="2-4"></td>
                <td id="pegbox"
                    <div class="peg-container">
                        <div class="peg" id="pegs2-1"></div>
                        <div class="peg" id="pegs2-2"></div>
                        <div class="peg" id="pegs2-3"></div>
                        <div class="peg" id="pegs2-4"></div>
                    </div>
                </td>
            </tr>
            <tr class="m-2">
                <td id="3-1"></td>
                <td id="3-2"></td>
                <td id="3-3"></td>
                <td id="3-4"></td>
                <td id="pegbox"
                    <div class="peg-container">
                        <div class="peg" id="pegs3-1"></div>
                        <div class="peg" id="pegs3-2"></div>
                        <div class="peg" id="pegs3-3"></div>
                        <div class="peg" id="pegs3-4"></div>
                    </div>
                </td>
            </tr>
            <tr class="m-2">
                <td id="4-1"></td>
                <td id="4-2"></td>
                <td id="4-3"></td>
                <td id="4-4"></td>
                <td id="pegbox"
                    <div class="peg-container">
                        <div class="peg" id="pegs4-1"></div>
                        <div class="peg" id="pegs4-2"></div>
                        <div class="peg" id="pegs4-3"></div>
                        <div class="peg" id="pegs4-4"></div>
                    </div>
                </td>
                </tr>
            <tr class="m-2">
                <td id="5-1"></td>
                <td id="5-2"></td>
                <td id="5-3"></td>
                <td id="5-4"></td>
                <td id="pegbox"
                    <div class="peg-container">
                        <div class="peg" id="pegs5-1"></div>
                        <div class="peg" id="pegs5-2"></div>
                        <div class="peg" id="pegs5-3"></div>
                        <div class="peg" id="pegs5-4"></div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="container d-flex justify-content-center mt-3">
        <table>
            <tr>
                <td class="letters" id="q" onclick="keyboard('q')">Q</td>
                <td class="letters" id="w" onclick="keyboard('w')">W</td>
                <td class="letters" id="e" onclick="keyboard('e')">E</td>
                <td class="letters" id="r" onclick="keyboard('r')">R</td>
                <td class="letters" id="t" onclick="keyboard('t')">T</td>
                <td class="letters" id="y" onclick="keyboard('y')">Y</td>
                <td class="letters" id="u" onclick="keyboard('u')">U</td>
                <td class="letters" id="i" onclick="keyboard('i')">I</td>
                <td class="letters" id="o" onclick="keyboard('o')">O</td>
                <td class="letters" id="p" onclick="keyboard('p')">P</td>
            </tr>
        </table>
    </div>
    <div class="container d-flex justify-content-center">
        <table>
            <tr>
                <td class="letters" id="a" onclick="keyboard('a')">A</td>
                <td class="letters" id="s" onclick="keyboard('s')">S</td>
                <td class="letters" id="d" onclick="keyboard('d')">D</td>
                <td class="letters" id="f" onclick="keyboard('f')">F</td>
                <td class="letters" id="g" onclick="keyboard('g')">G</td>
                <td class="letters" id="h" onclick="keyboard('h')">H</td>
                <td class="letters" id="j" onclick="keyboard('j')">J</td>
                <td class="letters" id="k" onclick="keyboard('k')">K</td>
                <td class="letters" id="l" onclick="keyboard('l')">L</td>
            </tr>
        </table>
    </div>
    <div class="container d-flex justify-content-center">
        <table>
            <tr>
                <td class="letters P" id="enter"  onclick="keyboard('enter')">&#9166</td>
                <td class="letters" id="z" onclick="keyboard('z')">Z</td>
                <td class="letters" id="x" onclick="keyboard('x')">X</td>
                <td class="letters" id="c" onclick="keyboard('c')">C</td>
                <td class="letters" id="v" onclick="keyboard('v')">V</td>
                <td class="letters" id="b" onclick="keyboard('b')">B</td>
                <td class="letters" id="n" onclick="keyboard('n')">N</td>
                <td class="letters" id="m" onclick="keyboard('m')">M</td>
                <td class="letters" id="delete" onclick="keyboard('delete')">&#x232B;</td>
            </tr>
        </table>
    </div>
    <p class="text-center mt-3" id="alert">Welcome to Mastermind</p>

</body>
</html>

<style>
    html {
        overflow-x: hidden;
        -webkit-user-select: none;        
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    h1 {
        font-weight: bold!important;
    }
    #navbar {
        background-color: #fff;
        border-bottom:1px solid #000;
    }
    a {
        color: #110e01!important;
    }
    body {
        background-color: #fff
    }
    table {
        border-collapse: separate;
        border-spacing: 6px;
    }
    td {
        width: 60px;
        height: 60px;
        border: 2px solid rgb(200, 200, 200);
        color: black;
        text-align: center;
        font-weight: bold;
        font-size: 30px;
    }
    .letters {
        width: 40px;
        height: 50px;
        background-color: rgb(220, 220, 220);
        border-radius: 5px;
        border: 2px solid rgb(220, 220, 220);
        color: #000;
        text-align: center;
        font-weight: bold;
        font-size: 20px;
    }
    p {
        font-size: 20px;
        font-weight: bold;
        color: #ff0000;
    }

    .peg {
/*         height: 20px; */
/*         width: 20px; */
        border-radius: 50%;
/*         background-color: green; */
        border: 1px solid #aaa;
    }

    .peg-container {
        display:grid;
        grid-template-columns: 20px 20px;
        grid-row: 20px 20px;
        grid-column-gap: 4px;
        grid-row-gap: 4px;
        padding: 6px 4px 8px 4px;
        border-width: 0px;
    }
    
    /* popup stuff */
    .center {
        /* border: 5px solid; */
        margin: auto;
        width: 100px;
        padding: 10px;
    }
    .popup {
        width: 100%;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        /* cursor: pointer; */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    /* The actual popup */
    .popup .popuptext {
        visibility: hidden;
        font-size: 12px;
        font-weight: 600;
        background-color: rgb(0, 0, 0);
        color: #fff;
        /* text-align: center; */
        border-radius: 4px;
        padding: 10px 10px;
        position: absolute;
        z-index: 1;
        margin-top: 10px;
    }
    /* Toggle this class - hide and show the popup */
    .popup .show {
        visibility: visible;
        -webkit-animation: fadeIn 1s;
        animation: fadeIn 2s;
    }
    /* Add animation (fade in the popup) */
    @-webkit-keyframes fadeIn {
        from {opacity: 0;} 
        to {opacity: 1;}
    }
    @keyframes fadeIn {
        from {opacity: 0;}
        to {opacity:1 ;}
    }
</style>
